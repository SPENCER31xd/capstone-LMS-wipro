# Library Management System - Docker Setup

This document provides complete instructions for running the Library Management System using Docker Compose with microservices architecture.

## 🏗️ Architecture Overview

The system is now split into multiple services:

- **Frontend**: Angular application (port 4200)
- **Gateway**: Main API entry point handling authentication and routing (port 5000)
- **Book Service**: Manages book operations (internal port 5001)
- **Member Service**: Manages member operations (internal port 5002)
- **Transaction Service**: Manages borrowing/returning operations (internal port 5003)

## 🚀 Quick Start

### 1. Prerequisites

- Docker Desktop installed and running
- Git (to clone the repository)

### 2. Build and Run

```bash
# Build all services
docker-compose up --build

# Or run in detached mode
docker-compose up --build -d
```

### 3. Access the Application

- **Frontend**: http://localhost:4200
- **Gateway API**: http://localhost:5000

## 📁 File Structure

```
├── docker-compose.yml              # Main Docker Compose configuration
├── Dockerfile.gateway             # Gateway service container
├── Dockerfile.book-service        # Book service container
├── Dockerfile.member-service      # Member service container
├── Dockerfile.transaction-service # Transaction service container
├── Dockerfile.frontend            # Frontend container
├── backend/
│   ├── gateway.py                 # Main gateway service
│   ├── book_service.py            # Book service
│   ├── member_service.py          # Member service
│   ├── transaction_service.py     # Transaction service
│   └── requirements.txt           # Python dependencies
└── src/environments/
    └── environment.docker.ts      # Docker environment config
```

## 🔧 Service Configuration

### Environment Variables

All services use the following environment variables:

```yaml
environment:
  - JWT_SECRET_KEY=your-secret-key-change-in-production
  - DATABASE_URL=/app/data/library.db
  - FLASK_ENV=production
  - HOST=0.0.0.0
```

### Service URLs (Internal Communication)

```yaml
environment:
  - BOOK_SERVICE_URL=http://book-service:5001
  - MEMBER_SERVICE_URL=http://member-service:5002
  - TRANSACTION_SERVICE_URL=http://transaction-service:5003
```

## 🌐 Network Configuration

- **Frontend**: Exposed on port 4200
- **Gateway**: Exposed on port 5000
- **Internal Services**: Only accessible within Docker network
- **Database**: Shared SQLite database via volume mount

## 🔐 Authentication & JWT

- JWT tokens are generated by the gateway service
- All service-to-service communication preserves JWT headers
- CORS is properly configured for cross-origin requests
- Authentication decorators are implemented in each service

## 📊 Health Checks

Each service includes health check endpoints:

- Gateway: `GET /api/books`
- Book Service: `GET /health`
- Member Service: `GET /health`
- Transaction Service: `GET /health`

## 🗄️ Database

- SQLite database is shared across all services
- Database file is stored in a Docker volume (`library-data`)
- Initial seed data includes:
  - Admin user: `admin@library.com` / `admin123`
  - Member user: `member@library.com` / `member123`
  - Sample books and transactions

## 🚨 Troubleshooting

### Common Issues

#### 1. "Authentication required" errors

**Cause**: JWT tokens not being passed correctly between services
**Solution**: Ensure all services are running and healthy

```bash
# Check service status
docker-compose ps

# Check service logs
docker-compose logs gateway
docker-compose logs book-service
docker-compose logs member-service
docker-compose logs transaction-service
```

#### 2. "value must be a string" errors

**Cause**: Data type mismatches between services
**Solution**: All services now properly handle data type conversions

#### 3. CORS errors

**Cause**: Frontend can't reach backend services
**Solution**: CORS is configured for all necessary origins

#### 4. Service communication failures

**Cause**: Services not accessible by name
**Solution**: Ensure all services are on the same Docker network

### Debugging Commands

```bash
# View all container logs
docker-compose logs -f

# View specific service logs
docker-compose logs -f gateway

# Check container status
docker-compose ps

# Restart specific service
docker-compose restart gateway

# Rebuild and restart all services
docker-compose down
docker-compose up --build
```

### Service Dependencies

The gateway service waits for all other services to be healthy before starting:

```yaml
depends_on:
  - book-service
  - member-service
  - transaction-service
```

## 🔄 Development Workflow

### 1. Make Changes

Edit the service files in the `backend/` directory:
- `gateway.py` - Main routing and authentication
- `book_service.py` - Book operations
- `member_service.py` - Member operations
- `transaction_service.py` - Transaction operations

### 2. Rebuild Services

```bash
# Rebuild specific service
docker-compose build book-service

# Rebuild all services
docker-compose build

# Restart with rebuild
docker-compose up --build
```

### 3. View Logs

```bash
# Follow logs for all services
docker-compose logs -f

# Follow logs for specific service
docker-compose logs -f book-service
```

## 🧪 Testing

### Test API Endpoints

```bash
# Test gateway health
curl http://localhost:5000/api/books

# Test authentication
curl -X POST http://localhost:5000/api/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@library.com","password":"admin123"}'

# Test with JWT token
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:5000/api/books
```

### Test Frontend

1. Open http://localhost:4200 in your browser
2. Login with admin credentials
3. Test book management, member management, and transactions

## 🚀 Production Deployment

### Security Considerations

1. **Change JWT Secret**: Update `JWT_SECRET_KEY` in docker-compose.yml
2. **Use HTTPS**: Configure SSL certificates for production
3. **Database**: Consider using PostgreSQL or MySQL for production
4. **Environment**: Set `FLASK_ENV=production`

### Scaling

```bash
# Scale specific services
docker-compose up --scale book-service=3

# Use Docker Swarm for production orchestration
docker stack deploy -c docker-compose.yml library
```

## 📝 API Endpoints

### Authentication
- `POST /api/login` - User login
- `POST /api/signup` - User registration

### Books
- `GET /api/books` - Get all books
- `GET /api/books/<id>` - Get specific book
- `POST /api/books` - Create book (admin only)
- `PUT /api/books/<id>` - Update book (admin only)
- `DELETE /api/books/<id>` - Delete book (admin only)

### Transactions
- `GET /api/transactions` - Get user transactions
- `POST /api/borrow/<book_id>` - Borrow a book
- `POST /api/return/<transaction_id>` - Return a book

### Members
- `GET /api/members` - Get all members (admin only)
- `PUT /api/members/<user_id>` - Update member (admin only)

## 🆘 Support

If you encounter issues:

1. Check the troubleshooting section above
2. Verify all services are running: `docker-compose ps`
3. Check service logs: `docker-compose logs [service-name]`
4. Ensure Docker Desktop is running
5. Try rebuilding: `docker-compose up --build`

## 🎯 Success Indicators

Your Docker setup is working correctly when:

✅ Frontend loads at http://localhost:4200
✅ Login works with admin credentials
✅ Books can be viewed and managed
✅ Members can be managed by admin
✅ Transactions work (borrow/return books)
✅ No "Authentication required" errors
✅ No "value must be a string" errors
✅ JWT tokens are properly passed between services

---

**Happy Dockerizing! 🐳**

